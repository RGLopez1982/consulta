<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Presupuestador V52 (Ultra Limpio)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --primary-blue: #0D47A1; 
            --accent-red: #D32F2F;   
            --bg-light: #F5F7FA;     
            --white: #FFFFFF;
            --text-dark: #2c3e50;
            --whatsapp-green: #25D366;
            --price-cash-color: #2E7D32; 
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding-bottom: 120px; background-color: var(--bg-light); color: var(--text-dark); scroll-behavior: smooth; }
        
        header { background-color: var(--primary-blue); color: var(--white); padding: 0 0 15px 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        
        .logos-bar { 
            background-color: var(--white); padding: 20px; display: flex; justify-content: center; align-items: center; gap: 20px; border-bottom: 4px solid var(--accent-red); margin-bottom: 10px; position: relative; 
        }
        .brand-logo { height: 90px; width: auto; max-width: 45vw; object-fit: contain; display: block; }
        @media (max-width: 600px) { .logos-bar { padding: 10px 5px; gap: 10px; } .brand-logo { height: 50px; max-width: 40vw; } .config-btn { font-size: 16px; top: 2px; right: 2px; } }

        .config-btn { position: absolute; top: 5px; right: 5px; background: none; border: none; font-size: 20px; cursor: pointer; opacity: 0.5; }
        #logoConfigPanel { display: none; background: #fff; padding: 15px; border-bottom: 1px solid #ccc; text-align: center; }
        
        .header-content { padding: 0 15px; }
        h1 { margin: 0 0 10px 0; font-size: 18px; font-weight: 700; letter-spacing: 0.5px; text-align: center; }
        
        .search-container { display: flex; background: var(--white); border-radius: 8px; padding: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); align-items: center; }
        .search-input { border: none; flex-grow: 1; padding: 10px; font-size: 16px; outline: none; border-radius: 8px; color: #333; }
        .search-btn { background: var(--white); border: 1px solid #cfd8dc; border-radius: 6px; padding: 0 10px; font-size: 18px; cursor: pointer; color: var(--accent-red); height: 40px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .search-btn:active { background: #f5f5f5; }
        .btn-clear { background: none; border: none; font-size: 18px; color: #aaa; padding: 0 10px; cursor: pointer; display: none; height: 40px; line-height: 40px; }
        
        /* Carga Minimalista */
        .upload-section { background: var(--white); padding: 5px 15px; text-align: center; border-bottom: 1px solid #e0e0e0; min-height: 20px; display: block; }
        .file-custom-btn { background-color: #E3F2FD; border: 2px dashed var(--primary-blue); color: var(--primary-blue); padding: 12px; border-radius: 8px; cursor: pointer; display: block; font-weight: bold; width: 100%; box-sizing: border-box; font-size: 14px; margin-bottom: 5px; }
        
        .results-info { padding: 10px 15px; font-size: 13px; color: #555; font-weight: 600; display: flex; justify-content: space-between; align-items: center; background: #e8eaf6; border-bottom: 1px solid #d0d0d0; }
        .container { max-width: 800px; margin: 0 auto; padding: 10px; }
        .card { background: var(--white); padding: 16px; margin-bottom: 12px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; border-left: 4px solid transparent; }
        .badge-code { font-size: 11px; background: #eceff1; color: #546e7a; padding: 3px 6px; border-radius: 4px; display: inline-block; margin-bottom: 6px; font-weight: bold; }
        .prod-desc { font-size: 15px; font-weight: 600; line-height: 1.4; margin-bottom: 8px; padding-right: 10px; color: #2c3e50; }
        
        .dual-price-container { display: flex; align-items: center; gap: 15px; margin: 8px 0; background: #f9f9f9; padding: 8px; border-radius: 6px; }
        .price-box { display: flex; flex-direction: column; }
        .price-label { font-size: 10px; text-transform: uppercase; color: #777; font-weight: bold; }
        .price-val-list { font-size: 18px; font-weight: 800; color: var(--accent-red); }
        .price-val-cash { font-size: 18px; font-weight: 800; color: var(--price-cash-color); }
        .divider { width: 1px; height: 30px; background: #ddd; }

        .action-row { display: flex; align-items: center; justify-content: space-between; margin-top: 12px; border-top: 1px solid #f0f0f0; padding-top: 10px; }
        .add-controls { display: flex; align-items: center; gap: 8px; margin-left: auto; }
        .qty-catalog { width: 35px; padding: 8px; text-align: center; border: 1px solid #cfd8dc; border-radius: 6px; font-size: 16px; font-weight: bold; color: var(--primary-blue); }
        .qty-input { width: 40px; padding: 8px; text-align: center; border: 1px solid #cfd8dc; border-radius: 6px; font-size: 16px; font-weight: bold; color: #333; }
        .qty-btn-adjust, .qty-btn-mini { background: #e0e0e0; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer; line-height: 1; height: 38px; display: flex; align-items: center; justify-content: center; }
        .qty-btn-mini { padding: 8px; width: 38px; height: 38px; background: #E3F2FD; color: var(--primary-blue); }
        .btn-add { background-color: var(--primary-blue); color: var(--white); border: none; padding: 10px 22px; border-radius: 30px; font-weight: bold; cursor: pointer; font-size: 13px; letter-spacing: 0.5px; box-shadow: 0 2px 5px rgba(13, 71, 161, 0.3); }
        .btn-add:active { transform: scale(0.98); }
        
        .pagination { display: flex; justify-content: center; align-items: center; gap: 15px; padding: 20px 0; }
        .page-btn { background: var(--white); border: 1px solid #cfd8dc; padding: 8px 16px; border-radius: 6px; font-weight: bold; color: var(--primary-blue); cursor: pointer; }
        .page-btn:disabled { background: #f5f5f5; color: #b0bec5; cursor: not-allowed; border-color: #eee; }
        .page-info { font-size: 14px; color: #555; }

        .client-input { width: 100%; padding: 12px; margin-top: 10px; border: 1px solid #cfd8dc; border-radius: 8px; font-size: 16px; box-sizing: border-box; outline-color: var(--primary-blue); }
        .budget-card { border-left: 5px solid var(--primary-blue); }
        .controls-row { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; border-top: 1px solid #f0f0f0; padding-top: 10px; }
        .btn-del { width: 32px; height: 32px; background: #ffebee; color: var(--accent-red); border: none; border-radius: 50%; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .footer { background: var(--white); padding: 15px 15px; border-top: 1px solid #e0e0e0; margin-top: 10px; border-radius: 20px 20px 0 0; box-shadow: 0 -4px 10px rgba(0,0,0,0.05); }
        .total-tarjeta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 14px; color: #546e7a; font-weight: 500; }
        .total-efectivo-box { background: #E3F2FD; padding: 12px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #BBDEFB; transition: all 0.2s ease-in-out; }
        .total-efectivo-box.authorized { border: 2px solid var(--accent-red); background: #ffcdd2; box-shadow: 0 0 10px rgba(211, 47, 47, 0.5); }
        .total-efectivo-box.authorized .efectivo-label { color: var(--accent-red); }
        .efectivo-label { font-size: 13px; color: var(--primary-blue); display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-weight: bold; text-transform: uppercase; }
        .efectivo-monto { font-size: 26px; font-weight: 900; color: var(--accent-red); text-align: right; display: block; margin-top: 5px; }
        .mini-disc-input { width: 40px; border: none; border-bottom: 2px solid var(--primary-blue); background: transparent; text-align: center; font-weight: bold; color: var(--primary-blue); font-size: 14px; margin: 0 5px; }
        .chips-container { display: flex; gap: 6px; justify-content: flex-start; margin-bottom: 5px; margin-top: 5px; flex-wrap: wrap; }
        .chip-btn { background: #fff; border: 1px solid #90CAF9; padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; color: #1976D2; cursor: pointer; transition: 0.2s; }
        .chip-btn:active { background: var(--primary-blue); color: #fff; transform: scale(0.95); }
        .chip-btn.active-chip { background: var(--primary-blue); color: #fff; border-color: var(--primary-blue); }
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .btn-pdf { width: 100%; background: var(--accent-red); color: var(--white); padding: 14px; border: none; border-radius: 10px; font-size: 15px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; box-shadow: 0 4px 6px rgba(211, 47, 47, 0.3); }
        .btn-whatsapp { width: 100%; background: var(--whatsapp-green); color: var(--white); padding: 14px; border: none; border-radius: 10px; font-size: 15px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; box-shadow: 0 4px 6px rgba(37, 211, 102, 0.3); }
        
        #btnScrollTop { position: fixed; bottom: 80px; right: 20px; width: 50px; height: 50px; background-color: var(--primary-blue); color: white; border: none; border-radius: 50%; font-size: 24px; cursor: pointer; display: none; z-index: 1500; align-items: center; justify-content: center; opacity: 0.9; }
        #toast { visibility: hidden; min-width: 200px; background-color: #263238; color: #fff; text-align: center; border-radius: 50px; padding: 12px; position: fixed; z-index: 3000; left: 50%; bottom: 80px; transform: translateX(-50%); font-size: 14px; opacity: 0; transition: opacity 0.2s, bottom 0.2s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 90px; }

        /* NAVBAR & BADGE */
        .nav { position: fixed; bottom: 0; width: 100%; height: 60px; background: var(--white); border-top: 1px solid #cfd8dc; display: flex; z-index: 2000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; color: #90a4ae; cursor: pointer; border: none; background: transparent; transition: 0.2s; position: relative; }
        .nav-item.active { color: var(--primary-blue); font-weight: bold; background-color: #f5f9fc; }
        .nav-icon { font-size: 24px; margin-bottom: 2px; }
        
        .nav-badge {
            position: absolute;
            top: 5px;
            right: calc(50% - 15px); 
            background-color: var(--accent-red);
            color: white;
            border-radius: 50%;
            padding: 2px 5px;
            font-size: 10px;
            font-weight: bold;
            min-width: 14px;
            text-align: center;
            display: none; 
            z-index: 10;
        }

        #customItemCard .card { border: 2px solid var(--accent-red); border-left: 4px solid var(--accent-red); }
        #customItemCard .client-input { border: 1px solid #cfd8dc; padding: 8px; box-sizing: border-box; }
    </style>
</head>
<body>
    <button id="btnScrollTop" onclick="scrollToTop()">‚¨Ü</button>

    <div id="viewCatalog">
        <header>
            <div class="logos-bar">
                <button class="config-btn" onclick="toggleLogoPanel()">‚öôÔ∏è</button>
                <img src="Logo.png" alt="Logo 1" class="brand-logo" id="imgLogo1" onerror="this.style.display='none'">
                <img src="logo_multicolor.png" alt="Logo 2" class="brand-logo" id="imgLogo2" onerror="this.style.display='none'">
            </div>
            
            <div id="logoConfigPanel">
                <p style="font-size:14px; font-weight:bold; margin-bottom:10px;">Configurar Logos</p>
                <label class="file-custom-btn" style="background:#fff3e0; color:#e65100; border-color:#e65100; margin-bottom:8px;">
                    üñºÔ∏è Logo Izq (Logo.png) <input type="file" accept="image/*" style="display:none" onchange="cargarLogoLocal(this, 'logo1')">
                </label>
                <label class="file-custom-btn" style="background:#fff3e0; color:#e65100; border-color:#e65100;">
                    üñºÔ∏è Logo Der (Multicolor) <input type="file" accept="image/*" style="display:none" onchange="cargarLogoLocal(this, 'logo2')">
                </label>
                <button onclick="borrarLogosLocales()" style="margin-top:10px; padding:8px 15px; border:none; background:#ffebee; color:#D32F2F; border-radius:4px; font-weight:bold;">üóëÔ∏è Borrar Logos</button>
                <br><br><button onclick="toggleLogoPanel()" style="padding:5px 15px; border:1px solid #999; background:#eee; border-radius:4px;">Cerrar</button>
            </div>

            <div class="header-content">
                <h1>Cat√°logo Online</h1>
                <div class="search-container">
                    <input type="text" id="searchInput" class="search-input" placeholder="Buscar (Ej: parag hilux)..." oninput="checkInput()">
                    <button id="btnClear" class="btn-clear" onclick="limpiarBuscador()">‚úñ</button>
                    <button class="search-btn" onclick="iniciarBusqueda()">üîç</button>
                </div>
            </div>
        </header>

        <div class="upload-section" id="uploadSection">
            <span id="lblFile" style="font-weight:bold; color:#0D47A1;">‚è≥ Conectando...</span>
            <label for="fileInput" id="lblManualInput" style="margin-top:5px; display:none; cursor:pointer; text-decoration:underline; font-size:11px;">(‚ö†Ô∏è Fall√≥ conexi√≥n. Toca para cargar Manual)</label>
            <input type="file" id="fileInput" accept=".xlsx, .xls" style="display:none;">
        </div>
        
        <div id="customItemWrapper" class="container" style="padding-bottom:0; display:none;">
            <div class="card" id="customItemCard">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div style="font-weight: 700; color: var(--accent-red); font-size: 16px;">‚ûï Art. Personalizado (C√≥d: 00)</div>
                    <button onclick="ocultarCustomItem()" style="background:none; border:none; color:#999; font-size: 24px; line-height: 1; cursor:pointer; padding: 0 5px;">&times;</button>
                </div>
                <label style="font-size:12px; color:#555;">Descripci√≥n:</label>
                <input type="text" id="custom_desc" placeholder="EJ: COLOR PREPARADO AZUL MET√ÅLICO 2.5L" class="client-input" style="margin-top:4px; margin-bottom:12px; text-transform: uppercase;" oninput="this.value = this.value.toUpperCase()">
                <div style="display: flex; gap: 10px; align-items: flex-end;">
                    <div style="flex-grow: 1;">
                        <label style="font-size:12px; color:#555;">Precio Unitario:</label>
                        <input type="number" id="custom_price" placeholder="0.00" class="client-input" style="margin-top:4px;">
                    </div>
                    <div style="width: 100px;">
                        <label style="font-size:12px; color:#555;">Cantidad:</label>
                        <div class="add-controls" style="width: 100%; margin-top:4px; margin-bottom:0; box-sizing: border-box; justify-content: center;">
                            <button class="qty-btn-mini" onclick="ajustarCantidadComodin(-1)">-</button>
                            <input type="number" id="custom_qty" value="1" min="1" class="qty-catalog">
                            <button class="qty-btn-mini" onclick="ajustarCantidadComodin(1)">+</button>
                        </div>
                    </div>
                </div>
                <div class="action-row" style="margin-top: 15px;">
                    <div></div>
                    <button class="btn-add" onclick="agregarCustom()">A√ëADIR AL PEDIDO</button>
                </div>
            </div>
        </div>
        
        <div class="results-info" id="resultsInfo" style="display:none;">
            <span id="txtCount">0 encontrados</span>
            <span id="txtPage">P√°g 1</span>
        </div>
        <div id="catalogList" class="container"></div>
        <div id="paginationControls" class="pagination" style="display:none;">
            <button class="page-btn" onclick="cambiarPagina(-1)" id="btnPrev">Anterior</button>
            <span class="page-info" id="lblPageIndicator">1 / 1</span>
            <button class="page-btn" onclick="cambiarPagina(1)" id="btnNext">Siguiente</button>
        </div>
    </div>

    <div id="viewBudget" style="display:none;">
        <header>
             <div class="logos-bar">
                <img src="Logo.png" alt="Logo 1" class="brand-logo" id="imgLogo1_bud" onerror="this.style.display='none'">
                <img src="logo_multicolor.png" alt="Logo 2" class="brand-logo" id="imgLogo2_bud" onerror="this.style.display='none'">
            </div>
            <div class="header-content"><h1>üìù Pedido en Curso</h1></div>
        </header>

        <div class="container" style="padding-bottom:0;">
            <input type="text" id="inputCliente" class="client-input" placeholder="üë§ Nombre del Cliente / Referencia" oninput="guardarDatosLocales()">
        </div>
        <div id="budgetList" class="container"></div>
        
        <div id="budgetFooter" class="footer" style="display:none;">
            <div class="total-tarjeta"><span>Precio Lista / Tarjeta:</span><span id="txtSubtotal" style="font-weight:bold;">$0.00</span></div>
            <div class="total-efectivo-box" id="efectivoBox">
                <div class="efectivo-label">
                    Efectivo / Transferencia
                    <span>Desc. <input type="number" id="inputDescuento" class="mini-disc-input" value="0" min="0" max="100" onchange="actualizarCarrito()" onkeydown="if(event.key === 'Enter') { event.preventDefault(); this.blur(); }" onfocus="this.select()">%</span>
                </div>
                <div class="chips-container">
                    <button class="chip-btn" onclick="setDescuento(0)">0%</button>
                    <button class="chip-btn" onclick="setDescuento(5)">5%</button>
                    <button class="chip-btn" onclick="setDescuento(10)">10%</button>
                    <button class="chip-btn" onclick="setDescuento(15)">15%</button>
                </div>
                <span id="txtTotalFinal" class="efectivo-monto">$0.00</span>
            </div>
            <div class="action-grid">
                <button class="btn-pdf" onclick="generarPDF()">üìÑ PDF</button>
                <button class="btn-whatsapp" onclick="enviarWhatsapp()">üì≤ WhatsApp</button>
            </div>
            <button onclick="borrarTodo()" style="width:100%; margin-top:5px; border:none; background:none; color: var(--accent-red); font-weight:bold; padding:10px;">üóëÔ∏è Borrar Todo</button>
        </div>
    </div>

    <div id="toast">Mensaje</div>
    
    <nav class="nav">
        <button class="nav-item active" onclick="cambiarVista('catalog')" id="navCat">
            <span class="nav-icon">üì¶</span>
            Cat√°logo
        </button>
        <button class="nav-item" onclick="cambiarVista('budget')" id="navBud">
            <span class="nav-icon">üõí</span>
            <span id="cartBadge" class="nav-badge">0</span> Pedido
        </button>
    </nav>

    <script>
        const CLAVE_AUTORIZACION = 'chpmc'; const MAX_DISC_SIN_CLAVE = 15;
        const ARCHIVO_LISTA_AUTOMATICA = 'Lista CHPMC.xlsx'; 
        const LOCAL_STORAGE_KEY = 'datosAppV52';
        const LOCAL_INVENTARIO_KEY = 'inventarioV52';
        const LOCAL_LOGO1_KEY = 'logo1_v44';
        const LOCAL_LOGO2_KEY = 'logo2_v44';
        
        let descuentoAutorizado = false; let inventario = []; let carrito = []; let resultadosBusqueda = []; let paginaActual = 1; const itemsPorPagina = 20;

        window.onload = function() { 
            cargarDatosLocales(); 
            recuperarLogos();
            if (inventario.length === 0) intentarCargaNube();
            else {
                // Si ya hay datos en memoria, OCULTAMOS la barra de carga directamente
                document.getElementById('uploadSection').style.display = 'none';
            }
        };

        function intentarCargaNube() {
            const lblFile = document.getElementById('lblFile');
            const manualInput = document.getElementById('lblManualInput');
            
            // Estado Inicial: Texto Conectando, input manual oculto
            lblFile.innerText = "‚è≥ Conectando..."; 
            manualInput.style.display = 'none';

            fetch(ARCHIVO_LISTA_AUTOMATICA + '?v=' + new Date().getTime())
                .then(response => {
                    if (!response.ok) throw new Error("No encontrada");
                    return response.arrayBuffer();
                })
                .then(data => {
                    const workbook = XLSX.read(new Uint8Array(data), {type: 'array'});
                    const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
                    procesarDatos(rows, 'Nube');
                })
                .catch(error => {
                    console.log(error);
                    // ‚ö†Ô∏è SOLO AQUI (SI FALLA) MOSTRAMOS EL BOT√ìN MANUAL
                    lblFile.innerText = ""; // Borramos el texto "Conectando"
                    manualInput.style.display = 'block'; // Aparece el bot√≥n manual
                    // Aseguramos que el contenedor sea visible
                    document.getElementById('uploadSection').style.display = 'block';
                });
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0]; if (!file) return;
            document.getElementById('lblFile').innerText = "‚è≥ Leyendo...";
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
                procesarDatos(rows, 'Manual');
            };
            reader.readAsArrayBuffer(file);
        });

        function procesarDatos(rows, source) {
            const lista = [];
            for(let i=1; i < rows.length; i++) {
                const fila = rows[i];
                if(fila && fila.length > 0) {
                    const codigo = fila[0] || "---"; const desc = fila[1] || "Sin nombre";
                    const precio = parseFloat(fila[4]) || 0; const precioCash = parseFloat(fila[5]) || 0; 
                    if(desc !== "Sin nombre") lista.push({ cod: codigo, desc: desc, precio: precio, precioCash: precioCash });
                }
            }
            inventario = lista;
            try { localStorage.setItem(LOCAL_INVENTARIO_KEY, JSON.stringify(inventario)); } catch(e){}
            
            // üí° V52: SI CARGA BIEN, OCULTAMOS TODO EL BLOQUE DE CARGA
            document.getElementById('uploadSection').style.display = 'none';
            
            resultadosBusqueda = inventario; paginaActual = 1; renderizarPagina();
        }

        // --- FUNCIONES LOGOS ---
        function toggleLogoPanel() { const p = document.getElementById('logoConfigPanel'); p.style.display = (p.style.display==='block') ? 'none' : 'block'; }
        function borrarLogosLocales() { localStorage.removeItem(LOCAL_LOGO1_KEY); localStorage.removeItem(LOCAL_LOGO2_KEY); alert("Logos borrados."); location.reload(); }
        function cargarLogoLocal(input, keyName) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const MAX_HEIGHT = 80; let width = img.width; let height = img.height;
                        if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                        const canvas = document.createElement('canvas'); canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        try {
                            if(keyName === 'logo1') localStorage.setItem(LOCAL_LOGO1_KEY, dataUrl);
                            if(keyName === 'logo2') localStorage.setItem(LOCAL_LOGO2_KEY, dataUrl);
                            aplicarLogos(keyName, dataUrl);
                            alert("‚úÖ Logo guardado.");
                        } catch (error) { alert("‚ùå Memoria llena."); }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        function recuperarLogos() {
            const l1 = localStorage.getItem(LOCAL_LOGO1_KEY); const l2 = localStorage.getItem(LOCAL_LOGO2_KEY);
            if(l1) aplicarLogos('logo1', l1); if(l2) aplicarLogos('logo2', l2);
        }
        function aplicarLogos(key, data) {
            if(key==='logo1') { document.getElementById('imgLogo1').src=data; document.getElementById('imgLogo1_bud').src=data; }
            if(key==='logo2') { document.getElementById('imgLogo2').src=data; document.getElementById('imgLogo2_bud').src=data; }
        }

        document.getElementById("searchInput").addEventListener("keypress", function(e) { if (e.key === "Enter") { e.preventDefault(); iniciarBusqueda(); } });
        function checkInput() { document.getElementById('btnClear').style.display = document.getElementById('searchInput').value.length > 0 ? 'block' : 'none'; }
        function limpiarBuscador() { const i = document.getElementById('searchInput'); i.value = ""; i.focus(); checkInput(); iniciarBusqueda(); }
        function ocultarCustomItem() { document.getElementById('customItemWrapper').style.display = 'none'; }
        
        function iniciarBusqueda() {
            const val = document.getElementById('searchInput').value.toLowerCase(); const terminos = val.split(" ").filter(t => t.length > 0);
            document.getElementById('customItemWrapper').style.display = (val.includes("00") && val.length > 0) ? 'block' : 'none';
            if (terminos.length === 0) resultadosBusqueda = inventario;
            else resultadosBusqueda = inventario.filter(p => { const t = (p.desc + " " + p.cod).toLowerCase(); if (p.cod==='00') return false; return terminos.every(tm => t.includes(tm)); });
            paginaActual = 1; renderizarPagina(); scrollToTop();
        }

        function renderizarPagina() {
            const div = document.getElementById('catalogList'); div.innerHTML = "";
            const total = resultadosBusqueda.length; const pags = Math.ceil(total / itemsPorPagina);
            if(paginaActual < 1) paginaActual = 1; if(paginaActual > pags && pags > 0) paginaActual = pags;
            
            document.getElementById('txtCount').innerText = `${total} productos`; document.getElementById('txtPage').innerText = pags > 0 ? `P√°g ${paginaActual}/${pags}` : "---";
            document.getElementById('resultsInfo').style.display = 'flex';
            if (total === 0) {
                if (document.getElementById('customItemWrapper').style.display !== 'block') div.innerHTML = "<div style='text-align:center; padding:40px; color:#999;'>No hay coincidencias.</div>";
                document.getElementById('paginationControls').style.display = 'none'; return;
            }
            const items = resultadosBusqueda.slice((paginaActual - 1) * itemsPorPagina, paginaActual * itemsPorPagina);
            items.forEach(p => {
                const pCash = p.precioCash > 0 ? p.precioCash : p.precio * 0.85;
                div.innerHTML += `
                    <div class="card">
                        <div><span class="badge-code">${p.cod}</span></div><div class="prod-desc">${p.desc}</div>
                        <div class="dual-price-container">
                            <div class="price-box"><span class="price-label">Lista / Tarjeta</span><span class="price-val-list">$${formatMoney(p.precio)}</span></div>
                            <div class="divider"></div>
                            <div class="price-box"><span class="price-label">Efectivo</span><span class="price-val-cash">$${formatMoney(pCash)}</span></div>
                        </div>
                        <div class="action-row"><div style="flex-grow:1;"></div><div class="add-controls">
                            <button class="qty-btn-adjust" onclick="ajustarCat('${p.cod}', -1)">-</button>
                            <input type="number" id="qty_${p.cod}" class="qty-catalog" value="1" min="1">
                            <button class="qty-btn-adjust" onclick="ajustarCat('${p.cod}', 1)">+</button>
                            <button class="btn-add" onclick="agregar('${p.cod}')">AGREGAR</button>
                        </div></div>
                    </div>`;
            });
            document.getElementById('paginationControls').style.display = 'flex';
            document.getElementById('lblPageIndicator').innerText = `${paginaActual} / ${pags}`;
            document.getElementById('btnPrev').disabled = (paginaActual === 1); document.getElementById('btnNext').disabled = (paginaActual === pags);
            if((paginaActual - 1) * itemsPorPagina > 0) document.getElementById('resultsInfo').scrollIntoView({behavior: 'smooth'});
        }

        function cambiarPagina(d) { paginaActual += d; renderizarPagina(); }
        function ajustarCat(c, d) { const i = document.getElementById(`qty_${c}`); if(!i)return; let n = (parseInt(i.value)||1)+d; if(n<1)n=1; i.value = n; }
        function ajustarCantidadComodin(d) { const i = document.getElementById('custom_qty'); if(!i)return; let n = (parseInt(i.value)||1)+d; if(n<1)n=1; i.value = n; }

        function agregarCustom() {
            const d = document.getElementById('custom_desc').value.trim(); const p = parseFloat(document.getElementById('custom_price').value)||0; const q = parseInt(document.getElementById('custom_qty').value)||1;
            if (d.length < 3 || p <= 0 || q < 1) return alert("Datos inv√°lidos");
            carrito.push({ cod: '00', desc: d, precio: p, cant: q, uuid: Date.now() }); actualizarCarrito(); mostrarToast("‚úÖ Agregado");
            document.getElementById('custom_desc').value=""; document.getElementById('custom_price').value=""; document.getElementById('custom_qty').value=1;
        }

        function agregar(cod) {
            let p = inventario.find(x => x.cod === cod);
            if (!p) { const ec = carrito.find(x => x.cod === cod); if(ec) p=ec; else return alert("Error de datos"); }
            const iq = document.getElementById(`qty_${cod}`); let q = iq ? (parseInt(iq.value)||1) : 1;
            const ec = carrito.find(x => x.cod === cod && !x.uuid);
            if(ec) { if(confirm(`Ya tienes ${ec.cant}. ¬øSumar ${q}?`)) { ec.cant += q; actualizarCarrito(); mostrarToast(`‚ûï Sumados ${q}`); if(iq) iq.value=1; } }
            else { carrito.push({ cod: p.cod, desc: p.desc, precio: p.precio, cant: q }); actualizarCarrito(); mostrarToast(`‚úÖ Agregados ${q}`); animarTab(); if(iq) iq.value=1; }
        }

        function setDescuento(v) { document.getElementById('inputDescuento').value = v; actualizarCarrito(); }

        function actualizarCarrito() {
            const div = document.getElementById('budgetList'); const foot = document.getElementById('budgetFooter');
            const discInput = document.getElementById('inputDescuento'); let disc = parseFloat(discInput.value)||0;
            
            if (disc > MAX_DISC_SIN_CLAVE && !descuentoAutorizado) {
                if (prompt("Clave:")?.toLowerCase() === CLAVE_AUTORIZACION) descuentoAutorizado=true;
                else { disc=MAX_DISC_SIN_CLAVE; discInput.value=MAX_DISC_SIN_CLAVE; }
            }
            if(descuentoAutorizado) document.getElementById('efectivoBox').classList.add('authorized');
            else document.getElementById('efectivoBox').classList.remove('authorized');

            const chips = document.querySelectorAll('.chip-btn');
            chips.forEach(b => { if(parseInt(b.innerText)===disc) b.classList.add('active-chip'); else b.classList.remove('active-chip'); });

            // üí° V52: ACTUALIZACI√ìN DEL BADGE
            const badge = document.getElementById('cartBadge');
            badge.innerText = carrito.length;
            badge.style.display = carrito.length > 0 ? 'block' : 'none';

            if(carrito.length===0) { div.innerHTML="<div style='text-align:center; padding:50px; color:#999;'>Vac√≠o</div>"; foot.style.display='none'; guardarDatosLocales(); return; }
            
            foot.style.display='block'; div.innerHTML=""; let sub=0;
            carrito.forEach((p, i) => {
                sub += p.precio * p.cant;
                div.innerHTML += `<div class="card budget-card"><div style="font-weight:600;">${p.desc}</div><div style="font-size:12px; color:#666;">C√≥d: ${p.cod}</div>
                <div class="controls-row"><div style="color:#555;">$${formatMoney(p.precio)}</div>
                <div style="display:flex; gap:5px;"><button class="qty-btn-mini" onclick="cambiarCant(${i}, carrito[${i}].cant-1)">-</button><input class="qty-input" value="${p.cant}" readonly><button class="qty-btn-mini" onclick="cambiarCant(${i}, carrito[${i}].cant+1)">+</button><button class="btn-del" onclick="borrar(${i})">‚úñ</button></div></div>
                <div style="text-align:right; font-weight:800; color:var(--primary-blue); margin-top:5px;">$${formatMoney(p.precio*p.cant)}</div></div>`;
            });
            const total = redondear500(sub * (1 - disc/100));
            document.getElementById('txtSubtotal').innerText = "$" + formatMoney(sub); document.getElementById('txtTotalFinal').innerText = "$" + formatMoney(total);
            guardarDatosLocales();
        }

        function cambiarCant(i, v) { if(v<1)v=1; carrito[i].cant=v; actualizarCarrito(); }
        function borrar(i) { carrito.splice(i,1); actualizarCarrito(); }
        function borrarTodo() { if(confirm("¬øBorrar todo?")) { carrito=[]; document.getElementById('inputCliente').value=""; actualizarCarrito(); } }
        function guardarDatosLocales() { localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({ carrito, cliente: document.getElementById('inputCliente').value, descuento: document.getElementById('inputDescuento').value, auth: descuentoAutorizado })); }
        function cargarDatosLocales() { 
            const d = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY)); 
            if(d) { carrito=d.carrito||[]; document.getElementById('inputCliente').value=d.cliente||""; document.getElementById('inputDescuento').value=d.descuento||0; descuentoAutorizado=d.auth||false; actualizarCarrito(); }
            try { const inv = localStorage.getItem(LOCAL_INVENTARIO_KEY); if(inv) inventario = JSON.parse(inv); } catch(e){}
        }
        
        function formatMoney(a) { return a.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2}); }
        function redondear500(v) { return Math.ceil(v/500)*500; }
        function mostrarToast(m) { const t=document.getElementById("toast"); t.innerText=m; t.className="show"; setTimeout(()=>t.className=t.className.replace("show",""), 1500); }
        function cambiarVista(v) { document.getElementById('viewCatalog').style.display=v==='catalog'?'block':'none'; document.getElementById('viewBudget').style.display=v==='budget'?'block':'none'; document.getElementById('navCat').className=v==='catalog'?'nav-item active':'nav-item'; document.getElementById('navBud').className=v==='budget'?'nav-item active':'nav-item'; window.scrollTo(0,0); }
        function scrollToTop() { window.scrollTo({top:0, behavior:'smooth'}); }
        window.onscroll = () => document.getElementById("btnScrollTop").style.display = (document.body.scrollTop>300||document.documentElement.scrollTop>300)?"flex":"none";
        function animarTab() { const b = document.getElementById('navBud'); b.style.transform="scale(1.2)"; setTimeout(()=>b.style.transform="scale(1)", 200); }

        function enviarWhatsapp() {
            if(carrito.length===0) return;
            const c = document.getElementById('inputCliente').value.trim(); const d = parseFloat(document.getElementById('inputDescuento').value)||0;
            let sub=0; carrito.forEach(p=>sub+=p.precio*p.cant); const tot = redondear500(sub*(1-d/100));
            let m = c ? `Hola *${c}*, ` : "Hola, "; m += "pedido:\n\n";
            carrito.forEach(p => m+=`‚ñ™ ${p.cant} x *[${p.cod}]* ${p.desc}\n`);
            m+=`\n*Tarjeta:* $${formatMoney(sub)}\n*Efectivo:* $${formatMoney(tot)}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(m)}`); borrarTodo();
        }

        function getBase64FromImageElement(id) {
            const img = document.getElementById(id); if(!img || !img.complete || img.naturalWidth===0) return null;
            try { const c = document.createElement("canvas"); c.width=img.width; c.height=img.height; const x=c.getContext("2d"); x.drawImage(img,0,0); return c.toDataURL("image/png"); } catch(e){return null;}
        }

        function generarPDF() {
            if(carrito.length===0) return alert("Pedido vac√≠o");
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            
            const l1 = getBase64FromImageElement('imgLogo1'); const l2 = getBase64FromImageElement('imgLogo2');
            if(l1) try { doc.addImage(l1, 'PNG', 14, 10, 40, 0); } catch(e){}
            if(l2) try { doc.addImage(l2, 'PNG', 155, 10, 40, 0); } catch(e){}

            doc.setFontSize(8);
            let yL = 35; 
            doc.text("Rivadavia 1299 - Rivadavia 1340 - Sgo", 14, yL); doc.text("Alem 603 - La Banda", 14, yL+4); doc.text("Tel: 3855135474 / 3856281309 / 3854739612", 14, yL+8);
            doc.text("Rivadavia 1270 - Sgo", 155, yL); doc.text("Bolivia (N) 158 - La Banda", 155, yL+4); doc.text("Tel: 3856258128 / 3854977332", 155, yL+8);

            const c = document.getElementById('inputCliente').value.trim()||"Cliente Final";
            doc.setFontSize(18); doc.setFont(undefined,'bold'); doc.text("PRESUPUESTO", 105, 55, null,null,"center");
            doc.setFontSize(12); doc.setFont(undefined,'normal'); doc.text("Fecha: "+new Date().toLocaleDateString('es-AR'), 14, 65); doc.text("Cliente: "+c, 14, 72);
            
            const body = carrito.map(p=>[p.cant, p.cod, p.desc, "$"+formatMoney(p.precio), "$"+formatMoney(p.precio*p.cant)]);
            doc.autoTable({ startY: 80, head: [['Cant', 'C√≥d', 'Descripci√≥n', 'Unit', 'Total']], body: body, theme: 'striped', headStyles: { fillColor: [13, 71, 161] } });
            
            let sub=0; carrito.forEach(p=>sub+=p.precio*p.cant);
            const d = parseFloat(document.getElementById('inputDescuento').value)||0; const tot = redondear500(sub*(1-d/100));
            
            let y = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(11); doc.text("Precio Lista / Tarjeta: $"+formatMoney(sub), 195, y, null,null,"right");
            y+=10; doc.setFontSize(14); doc.setFont(undefined,'bold'); doc.text("Efectivo/Transf: $"+formatMoney(tot), 195, y, null,null,"right");
            y+=20; doc.setFontSize(10); doc.setFont(undefined,'italic'); doc.text("Condiciones:", 14, y); doc.text("- Entrega en 24hs", 14, y+6); doc.text("- Presupuesto v√°lido por 7 d√≠as", 14, y+12);
            
            doc.save(`Presupuesto_${c.replace(/\s+/g,'_')}.pdf`);
        }
    </script>
</body>
</html>
